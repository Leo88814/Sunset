@model Theater_Admin.Models.Dtos.MovieDto

@{
    ViewBag.Title = "新增电影";
}

<h2>新增电影</h2>

<div id="app">
    <form id="movieForm">
        <div class="mb-3">
            <label for="movieName" class="form-label">电影名称</label>
            <input type="text" class="form-control" id="movieName" v-model="movie.MovieName" required>
        </div>
        <div class="mb-3">
            <label for="englishName" class="form-label">英文名称</label>
            <input type="text" class="form-control" id="englishName" v-model="movie.EnglishName" required>
        </div>
        <div class="mb-3">
            <label for="genreId" class="form-label">类型</label>
            <select class="form-select" id="genre" v-model="movie.GenreId" required>
                <option value="1">动作</option>
                <option value="2">喜剧</option>
                <option value="3">剧情</option>
                <option value="4">恐怖</option>
                <option value="5">科幻</option>
                <option value="6">爱情</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="grading" class="form-label">分级</label>
            <input type="text" class="form-control" id="grading" v-model="movie.Grading" required>
        </div>
        <div class="mb-3">
            <label for="synopsis" class="form-label">剧情简介</label>
            <textarea class="form-control" id="synopsis" v-model="movie.Synopsis" rows="3" required></textarea>
        </div>
        <div class="mb-3">
            <label for="trailerURL" class="form-label">预告片链接</label>
            <input type="url" class="form-control" id="trailerURL" v-model="movie.TrailerURL" required>
        </div>
        <div class="mb-3">
            <label for="premiereDate" class="form-label">首映日期</label>
            <input type="date" class="form-control" id="premiereDate" v-model="movie.PremiereDate" required>
        </div>
        <div class="mb-3">
            <label for="onAir" class="form-label">是否上映</label>
            <select class="form-select" id="onAir" v-model="movie.OnAir" required>
                <option :value="true">是</option>
                <option :value="false">否</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="director" class="form-label">导演</label>
            <input type="text" class="form-control" id="director" v-model="movie.Director" required>
        </div>
        <div class="mb-3">
            <label for="movieCast" class="form-label">演员</label>
            <input type="text" class="form-control" id="movieCast" v-model="movie.MovieCast" required>
        </div>
        <div class="mb-3">
            <label for="movieLanguage" class="form-label">语言</label>
            <input type="text" class="form-control" id="movieLanguage" v-model="movie.MovieLanguage" required>
        </div>
        <div class="mb-3">
            <label for="duration" class="form-label">片长 (分钟)</label>
            <input type="number" class="form-control" id="duration" v-model="movie.Duration" required>
        </div>
        <div class="mb-3">
            <label for="distributor" class="form-label">发行商</label>
            <input type="text" class="form-control" id="distributor" v-model="movie.Distributor" required>
        </div>
        <div class="mb-3">
            <label for="mainPicture" class="form-label">主要海报</label>
            <input type="file" class="form-control" id="mainPicture" v-on:change="previewImage" required>
            <img v-bind:src="movie.MainPicture" alt="电影海报" class="img-thumbnail mt-2" v-if="movie.MainPicture">
        </div>
        <button type="button" class="btn btn-primary" v-on:click="addMovie">新增电影</button>
    </form>
</div>

@section scripts {
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp, ref } = Vue;

        createApp({
            setup() {
                const movie = ref({
                    MovieName: "",
                    EnglishName: "",
                    GenreId: null,
                    MovieImageId: null,
                    Grading: "",
                    Synopsis: "",
                    TrailerURL: "",
                    PremiereDate: null,
                    OnAir: false,
                    Director: "",
                    MovieCast: "",
                    MovieLanguage: "",
                    Duration: null,
                    Distributor: "",
                    MainPicture: "",
                    TotalRating: 0
                });

                const previewImage = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            movie.value.MainPicture = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                };

                const addMovie = async () => {
                    // 检查必填字段
                    if (!movie.value.MovieName || !movie.value.GenreId || !movie.value.Duration) {
                        alert('请填写所有必填字段');
                        return;
                    }

                    try {
                        const response = await fetch('/apis/MovieApi/Create', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(movie.value)
                        });

                        if (response.ok) {
                            alert('电影添加成功！');
                            // 重置表单或跳转到电影列表页面
                            // window.location.href = '/Movie/Index';
                        } else {
                            alert('添加电影失败，请重试。');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('发生错误，请重试。');
                    }
                };

                return {
                    movie,
                    previewImage,
                    addMovie
                };
            }
        }).mount("#app");
    </script>
}