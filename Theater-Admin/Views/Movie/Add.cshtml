@model Theater_Admin.Models.Vms.MovieVm

@{
    ViewBag.Title = "新增電影";
}

<h2>新增電影</h2>

<div id="app">
    <div class="sidebar d-flex flex-column flex-shrink-0 p-3">
        <h2 class="text-center text-white mb-4">管理系統</h2>
        <ul class="nav nav-pills flex-column mb-auto">
            <!-- 維護會員系統 -->
            <li class="nav-item">
                <a class="nav-link text-white"
                   data-bs-toggle="collapse"
                   href="#collapseMember"
                   role="button"
                   aria-expanded="false"
                   aria-controls="collapseMember">
                    維護會員系統
                </a>
                <div class="collapse" id="collapseMember">
                    <ul class="nav flex-column ms-3">
                        <li>
                            <a href="@Url.Action("Index", "Members")" class="nav-link text-white">註銷會員</a>
                        </li>
                    </ul>
                </div>
            </li>
            <!-- 電影詳情頁面 -->
            <li>
                <a class="nav-link text-white"
                   data-bs-toggle="collapse"
                   href="#collapseMovie"
                   role="button"
                   aria-expanded="false"
                   aria-controls="collapseMovie">
                    電影清單頁面
                </a>
                <div class="collapse" id="collapseMovie">
                    <ul class="nav flex-column ms-3">
                        <li>
                            <a href="@Url.Action("Index", "Movie")" class="nav-link text-white">電影清單</a>
                        </li>
                    </ul>
                </div>
            </li>
            <!-- 購票訂位系統 -->
            <li>
                <a class="nav-link text-white"
                   data-bs-toggle="collapse"
                   href="#collapseBooking"
                   role="button"
                   aria-expanded="false"
                   aria-controls="collapseBooking">
                    購票訂位系統
                </a>
                <div class="collapse" id="collapseBooking">
                    <ul class="nav flex-column ms-3">
                        <li>
                            <a href="@Url.Action("Index", "Auditorum")" class="nav-link text-white">影廳管理</a>
                        </li>
                        <li>
                            <a href="@Url.Action("ShowtimeIndex", "ShowTimes")" class="nav-link text-white">場次管理</a>
                        </li>
                    </ul>
                </div>
            </li>
            <!-- 客服Q&A -->
            <li>
                <a href="@Url.Action("Logout", "Users")" class="nav-link text-white">登出</a>
            </li>
        </ul>
    </div>
    <div class="header ">
        <div class="container-fluid d-flex  ">

            <h1 class="text-end pe-5 pt-2" style="align-content">Sunset影城管理系統</h1>
            <img src="~/Img/sunset-svgrepo-com.png" alt="Logo" class="me-3" />
        </div>
    </div>
    <form id="movieForm" enctype="multipart/form-data" class="main-content container justify-content-center text-center">
        <div class="mb-3">
            <label for="movieName" class="form-label">電影名稱</label>
            <input type="text" class="form-control " id="movieName" v-model="movie.movieName" required>
        </div>
        <div class="mb-3">
            <label for="englishName" class="form-label">英文名稱</label>
            <input type="text" class="form-control" id="englishName" v-model="movie.englishName" required>
        </div>
        <div class="mb-3">
            <label for="genreId" class="form-label">類型</label>
            <select class="form-select" id="genre" v-model="movie.genreId" required>
                <option value="1">動作</option>
                <option value="2">喜劇</option>
                <option value="3">劇情</option>
                <option value="4">恐怖</option>
                <option value="5">科幻</option>
                <option value="6">愛情</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="grading" class="form-label">分級</label>
            <select class="form-select" id="grading" v-model="movie.grading" required>
                <option value="普遍級">普遍級</option>
                <option value="保護級">保護級</option>
                <option value="輔導級">輔導級</option>
                <option value="限制級">限制級</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="synopsis" class="form-label">劇情簡介</label>
            <textarea class="form-control" id="synopsis" v-model="movie.synopsis" rows="3" required></textarea>
        </div>
        <div class="mb-3">
            <label for="trailerURL" class="form-label">預告片連結</label>
            <input type="url" class="form-control" id="trailerURL" v-model="movie.trailerURL" required>
        </div>
        <div class="mb-3">
            <label for="premiereDate" class="form-label">首映日期</label>
            <input type="date" class="form-control" id="premiereDate" v-model="movie.premiereDate" required>
        </div>
        <div class="mb-3">
            <label for="onAir" class="form-label">是否上映</label>
            <select class="form-select" id="onAir" v-model="movie.onAir" required>
                <option :value="true">是</option>
                <option :value="false">否</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="director" class="form-label">導演</label>
            <input type="text" class="form-control" id="director" v-model="movie.director" required>
        </div>
        <div class="mb-3">
            <label for="movieCast" class="form-label">演員</label>
            <input type="text" class="form-control" id="movieCast" v-model="movie.movieCast" required>
        </div>
        <div class="mb-3">
            <label for="movieLanguage" class="form-label">語言</label>
            <input type="text" class="form-control" id="movieLanguage" v-model="movie.movieLanguage" required>
        </div>
        <div class="mb-3">
            <label for="duration" class="form-label">片長 (分鐘)</label>
            <input type="number" class="form-control" id="duration" v-model="movie.duration" required>
        </div>
        <div class="mb-3">
            <label for="distributor" class="form-label">發行商</label>
            <input type="text" class="form-control" id="distributor" v-model="movie.distributor" required>
        </div>
        <div class="mb-3">
            <label for="mainPicture" class="form-label">主要海報</label>
            <input type="file" class="form-control" id="mainPicture" ref="mainPicture" v-on:change="previewImage" required>
            <img :src="previewImageUrl" alt="電影海報" class="img-thumbnail mt-2" v-if="previewImageUrl">
        </div>
        <button type="button" class="btn btn-primary" v-on:click="addMovie">新增電影</button>
    </form>
</div>

@section scripts {
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const app = Vue.createApp({

            setup() {
                const movie = Vue.ref({
                    id: 0,
                    movieName: "",
                    englishName: "",
                    genreId: null,
                    movieImageId: null,
                    grading: "",
                    synopsis: "",
                    trailerURL: "",
                    premiereDate: null,
                    onAir: false,
                    director: "",
                    movieCast: "",
                    movieLanguage: "",
                    duration: null,
                    distributor: "",
                    mainPicture: "",
                    totalRating: 0
                });
                const previewImageUrl = Vue.ref(null);
                const mainPicture = Vue.ref(null);

                const previewImage = async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            previewImageUrl.value = e.target.result;
                        };
                        reader.readAsDataURL(file);

                        // 上傳圖片
                        const formData = new FormData();
                        formData.append('file', file);
                        try {
                            const response = await fetch('/apis/movie/UploadImage', {
                                method: 'POST',
                                body: formData
                            });
                            if (response.ok) {
                                const result = await response.json();
                                movie.value.mainPicture = result.fileName;

                            } else {
                                alert('圖片上傳失敗，請重試。');
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('圖片上傳時發生錯誤，請重試。');
                        }
                    }
                };

                const addMovie = async () => {
                    // 檢查必填欄位
                    if (!movie.value.movieName || !movie.value.genreId || !movie.value.duration) {
                        alert('請填寫所有必填欄位');
                        return;
                    }

                    try {
                        const response = await fetch('/apis/movie/Create', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify(movie.value)
                        });

                        if (response.ok) {
                            alert('電影新增成功！');
                            // 重置表單或跳轉到電影列表頁面
                            window.location.href = `@Url.Action("Index", "Movie")`;
                            // window.location.href = '/Movie/Index';
                        } else {
                            const errorText = await response.text();
                            alert('新增電影失敗，請重試。錯誤訊息：' + errorText);
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('發生錯誤，請重試。');
                    }
                };

                return {
                    movie,
                    previewImageUrl,
                    previewImage,
                    addMovie
                };
            }
        });

        app.mount("#app");
    </script>
}