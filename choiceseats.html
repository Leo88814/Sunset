<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>線上訂票</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/css/styles.css" />
    <style>
      #seats {
        max-width: 80vw;
      }
    </style>
  </head>
  <body>
    <div id="app" class="container">
      <header>
        <nav class="navbar navbar-expand-lg bg-body-tertiary">
          <div class="container-fluid">
            <a class="navbar-brand" href="#">Home</a>
            <button
              class="navbar-toggler"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#navbarNavDropdown"
              aria-controls="navbarNavDropdown"
              aria-expanded="false"
              aria-label="Toggle navigation"
            >
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavDropdown">
              <ul class="navbar-nav">
                <li class="nav-item dropdown">
                  <a
                    class="nav-link dropdown-toggle"
                    href="#"
                    role="button"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    電影列表
                  </a>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">強檔熱映</a></li>
                    <li><a class="dropdown-item" href="#">即將上映</a></li>
                  </ul>
                </li>

                <li class="nav-item">
                  <a class="nav-link" href="#">線上訂票</a>
                </li>

                <li class="nav-item">
                  <a class="nav-link" href="#">影城介紹</a>
                </li>

                <li class="nav-item dropdown">
                  <a
                    class="nav-link dropdown-toggle"
                    href="#"
                    role="button"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    會員專區
                  </a>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">變更資料</a></li>
                    <li><a class="dropdown-item" href="#">變更密碼</a></li>
                    <li><a class="dropdown-item" href="#">票夾</a></li>
                    <li><a class="dropdown-item" href="#">歷史訂單</a></li>
                    <li><a class="dropdown-item" href="#">儲值資訊</a></li>
                  </ul>
                </li>

                <li class="nav-item">
                  <a class="nav-link" href="#">客服Q&A</a>
                </li>
              </ul>

              <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                  <a class="nav-link" href="#">您好! XXX</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#">登出</a>
                </li>
              </ul>
            </div>
          </div>
        </nav>
      </header>
      <nav style="--bs-breadcrumb-divider: '>'" aria-label="breadcrumb">
        <ol class="breadcrumb ms-3">
          <li class="breadcrumb-item"><a href="#">Home</a></li>
          <li class="breadcrumb-item active" aria-current="page">線上訂票</li>
        </ol>
      </nav>

      <section class="login-section">
        <h2 class="text">線上訂票步驟</h2>
        <div class="step-bar">
          <div class="step-item">1.選擇電影</div>
          <div class="step-item fw-bolder">2.場次選擇</div>
          <div class="step-item">3.確認訂單</div>
          <div class="step-item">4.訂單完成</div>
        </div>

        <div class="container mt-3">
          <div class="row">
            <div class="col-md-3 col-sm-6">
              帳號限購最多五張票
              <div class="mt-2">優待票：學生證、軍警相關證明文件。</div>
              <div class="mt-2">
                愛心票：未滿5歲、年滿65歲以上，身心障礙人士需出示身心障礙證件入場需出示證件。
              </div>
            </div>
            <!--選擇票種-->
            <div class="col-md-9 col-sm-6">
              <h5 class="fw-bolder">選擇票種</h5>
              <div class="row">
                <div
                  class="col-4"
                  v-for="(ticket, index) in ticketTypes"
                  :key="ticket.name"
                >
                  {{ ticket.name }} {{ ticket.price }}元
                  <select v-model="ticket.selected" class="form-select">
                    <option
                      v-for="n in availableOptions(ticket)"
                      :key="n"
                      :value="n"
                    >
                      {{ n }}
                    </option>
                  </select>
                </div>
              </div>
              <!-- 顯示票種錯誤訊息 -->
              <div class="text-danger" v-if="ticketError">
                {{ ticketError }}
              </div>
            </div>
          </div>
        </div>

        <img src="/seats/座位圖.jpg" class="mt-3" id="seats" />
        <!-- 顯示座位選擇 -->
        <div class="row mt-3">
          <h5 class="fw-bolder">選擇座位</h5>
          <div class="col-12">
            <div v-for="n in totalTickets" :key="n" class="mt-2">
              座位選擇 {{ n }}
              <select v-model="selectedSeats[n - 1]" class="form-select">
                <option
                  v-for="seat in filteredSeats(n - 1)"
                  :key="seat"
                  :value="seat"
                >
                  {{ seat }}
                </option>
              </select>
            </div>
          </div>
          <!-- 顯示座位錯誤訊息 -->
          <div class="text-danger" v-if="seatError">{{ seatError }}</div>
        </div>

        <div class="text-end mt-3">
          <button @click="goToPreviousPage" class="btn btn-outline-danger">
            上一頁
          </button>
          <button @click="goToNextPage" class="btn btn-outline-primary ms-2">
            下一頁
          </button>
        </div>
      </section>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="https://unpkg.com/vue@3.5.4/dist/vue.global.js"></script>
    <script>
      const { createApp, ref, computed } = Vue;

      const config = {
        setup() {
          const maxTickets = ref(5); // 每個票種最大選擇數量
          const maxTotalTickets = ref(5); // 總共最大票數限制

          // 票種資料
          const ticketTypes = ref([
            { name: "全票", price: 230, selected: 0 },
            { name: "優待票", price: 200, selected: 0 },
            { name: "愛心票", price: 180, selected: 0 },
          ]);

          const selectedSeats = ref([]); // 座位選擇
          const ticketError = ref(""); // 票種錯誤訊息
          const seatError = ref(""); // 座位錯誤訊息

          // 所有可用的座位
          const availableSeats = ref([
            "A1",
            "A2",
            "A3",
            "A4",
            "A5",
            "A6",
            "A7",
            "A8",
            "A9",
            "A10",
            "A11",
            "A12",
            "A13",
            "A14",
            "A15",
            "A16",
            "B1",
            "B2",
            "B3",
            "B4",
            "B5",
            "B6",
            "B7",
            "B8",
            "B9",
            "B10",
            "B11",
            "B12",
            "B13",
            "B14",
            "B15",
            "B16",
            "C1",
            "C2",
            "C3",
            "C4",
            "C5",
            "C6",
            "C7",
            "C8",
            "C9",
            "C10",
            "C11",
            "C12",
            "C13",
            "C14",
            "C15",
            "C16",
            "D1",
            "D2",
            "D3",
            "D4",
            "D5",
            "D6",
            "D7",
            "D8",
            "D9",
            "D10",
            "D11",
            "D12",
            "D13",
            "D14",
            "D15",
            "D16",
            "E1",
            "E2",
            "E3",
            "E4",
            "E5",
            "E6",
            "E7",
            "E8",
            "E9",
            "E10",
            "E11",
            "E12",
            "E13",
            "E14",
            "E15",
            "E16",
          ]);

          const totalTickets = computed(() => {
            return ticketTypes.value.reduce(
              (sum, ticket) => sum + ticket.selected,
              0
            );
          });

          const availableOptions = (ticket) => {
            const remainingTickets = maxTotalTickets.value - totalTickets.value;
            const currentSelected = ticket.selected;
            return Array.from(
              {
                length:
                  Math.min(
                    remainingTickets + currentSelected,
                    maxTickets.value
                  ) + 1,
              },
              (_, i) => i
            );
          };

          const filteredSeats = (index) => {
            const selected = selectedSeats.value.filter(
              (seat, i) => i !== index
            );
            return availableSeats.value.filter(
              (seat) => !selected.includes(seat)
            );
          };

          const validateSelection = () => {
            let valid = true;

            if (totalTickets.value === 0) {
              ticketError.value = "請至少選擇一種票種！";
              valid = false;
            } else {
              ticketError.value = "";
            }

            if (
              selectedSeats.value.length < totalTickets.value ||
              selectedSeats.value.includes("")
            ) {
              seatError.value = "請選擇對應數量的座位！";
              valid = false;
            } else {
              seatError.value = "";
            }

            return valid;
          };

          // 儲存票種類型資料
          const saveTicketSelection = () => {
            const selectedTicketInfo = ticketTypes.value
              .filter((ticket) => ticket.selected > 0)
              .map((ticket) => ({
                name: ticket.name,
                price: ticket.price,
                quantity: ticket.selected,
              }));

            localStorage.setItem(
              "selectedTickets",
              JSON.stringify(selectedTicketInfo)
            );
          };

          // 儲存座位資料
          const saveSeatSelection = () => {
            localStorage.setItem(
              "selectedSeats",
              JSON.stringify(selectedSeats.value)
            );
          };

          // 儲存所有選擇 (調用各自的儲存函數)
          const saveAllSelections = () => {
            saveTicketSelection();
            saveSeatSelection();
          };

          const goToNextPage = () => {
            if (validateSelection()) {
              saveAllSelections();
              window.location.href = "checkorder.html";
            }
          };

          const goToPreviousPage = () => {
            window.location.href = "choicedate.html";
          };

          return {
            maxTickets,
            maxTotalTickets,
            ticketTypes,
            selectedSeats,
            totalTickets,
            availableOptions,
            availableSeats,
            filteredSeats,
            ticketError,
            seatError,
            goToNextPage,
            goToPreviousPage,
            saveTicketSelection,
            saveSeatSelection,
            saveAllSelections,
          };
        },
      };

      const app = createApp(config);
      app.mount("#app");
    </script>
  </body>
</html>
